#!/bin/bash

LOCAL_REPO=<%= @local_repo %>

cd $(dirname $0)

if [ "$1" ] ; then
    BRANCH="$1"
else
    BRANCH="branches/RB"
fi

clusters="pro
pre
hq
"
echo -e "\nSelect deploy environment:"
echo "${clusters}" | nl
read CHOICE
cluster=$(echo "${clusters}" | sed -n "${CHOICE}p")

rm -rf kettle
cp -r ${LOCAL_REPO}/${BRANCH}/kettle kettle

# Force local setup into server.properties
for i in $(find kettle -name server-${cluster}.properties) ; do
    dst=$(dirname $i)/server.properties
    cat common-${cluster}.properties \
        <(eval cat $i \
            $(for i in $(sed -e "s/=.*//" common-${cluster}.properties) ; do echo -n " | grep -v ^$i=" ; done) \
        ) \
    > $dst
done

# Remove unused server.properties templates
find kettle -name server-hq.properties -or -name server-pre.properties -or -name server-pro.properties | xargs -L1024 rm -f

# Detect and report changes in server-*.properties files
if ! diff_output=$(LANG=C diff -ur /opt/data-integration/beabloo_kettle-${cluster} kettle) ; then
    echo "${diff_output}" | grep -v ^O | less
fi

echo -e "\nDifferences between SVN & Prod:"
rsync -anvr --del --force -c --exclude=subversion kettle/ /opt/data-integration/beabloo_kettle-${cluster}

echo -e "\nDo you want to apply changes (y/n)?:"
read CHOICE
case ${CHOICE} in
    y|Y)
        rsync -avr --del --force -c --exclude=subversion kettle/ /opt/data-integration/beabloo_kettle-${cluster}
        mkdir -p /opt/sql/scripts/kettle-${cluster}
        cp kettle/JOBS /opt/sql/scripts/kettle-${cluster}/JOBS
        ;;
    n|n) 
        exit 0
        ;;
    *)
        exit 1
        ;;
esac
