
#!/bin/bash

cd $(dirname $0)

LOCAL_REPO=<%= @local_repo %>

cd $(dirname $0)
source cluster.conf

rm -rf kettle
cp -r ${LOCAL_REPO}/$1/kettle kettle

# Force local setup into server.properties
for i in $(find kettle -name server-${cluster}.properties) ; do
    dst=$(dirname $i)/server.properties
    cat common.properties \
        <(eval cat $i \
            $(for i in $(sed -e "s/=.*//" common.properties) ; do echo -n " | grep -v ^$i=" ; done) \
        ) \
    > $dst
done

# Remove unused server.properties templates
find kettle -name server-hq.properties -or -name server-pre.properties -or -name server-pro.properties | xargs -L1024 rm -f

# Detect and report changes in server-*.properties files
rm -rf unmodified_kettle_properties_from_svn
cp -a /opt/data-integration/beabloo_kettle unmodified_kettle_properties_from_svn
find unmodified_kettle_properties_from_svn -type f -not -name server.properties | xargs -L512 rm -f
if ! diff_output=$(LANG=C diff -ur unmodified_kettle_properties_from_svn kettle) ; then
    echo "${diff_output}" | grep -v ^O | less
fi

echo -e "\nDifferences between SVN & Prod:"
rsync -anvr --del --force -c --exclude=subversion kettle/ /opt/data-integration/beabloo_kettle

echo -e "\nDo you want to apply changes (y/n)?:"
read CHOICE
case ${CHOICE} in
    y|Y)
        rsync -avr --del --force -c --exclude=subversion kettle/ /opt/data-integration/beabloo_kettle
        cp kettle/JOBS /opt/sql/scripts/kettle/JOBS
        ;;
    n|n) 
        exit 0
        ;;
    *)
        exit 1
        ;;
esac
